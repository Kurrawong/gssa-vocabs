trigger:
  branches:
    include:
      - main

jobs:
  - deployment: vocabs_dev_deployment
    environment: vocabs-dev
    pool:
      vmImage: "ubuntu-latest"
    variables:
      - group: vocabs-dev
    strategy:
      runOnce:
        deploy:
          steps:
            - checkout: self

            - task: CmdLine@2
              displayName: "Install Taskfile"
              inputs:
                script: |
                  sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b ~/.local/bin
                  echo '##vso[task.prependpath]~/.local/bin'
                  task --version

            - task: CmdLine@2
              displayName: "Install uv"
              inputs:
                script: |
                  curl -LsSf https://astral.sh/uv/install.sh | sh
                  echo '##vso[task.prependpath]~/.local/bin'
                  uv --version

            - task: CmdLine@2
              displayName: "Install python"
              inputs:
                script: |
                  uv install python@$(PYTHON_VERSION)
                  python --version

            - task: CmdLine@2
              displayName: "Install kurra"
              inputs:
                script: |
                  uv tool install kurra
                  kurra --version

            - task: CmdLine@2
              displayName: "Get IP address of runner"
              inputs:
                script: |
                  curl ifconfig.me

            - task: CmdLine@2
              displayName: "Test database connection"
              inputs:
                script: |
                  kurra db list '$(FUSEKI_URL)' --username '$(FUSEKI_USERNAME)' --password '$(FUSEKI_PASSWORD)'

            - task: CmdLine@2
              displayName: "Upload vocabularies"
              inputs:
                script: |
                  kurra file upload vocabularies/ '$(FUSEKI_URL)/$(FUSEKI_DATASET)' --username '$(FUSEKI_USERNAME)' --password '$(FUSEKI_PASSWORD)'
